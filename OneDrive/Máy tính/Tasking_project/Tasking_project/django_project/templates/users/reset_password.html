{% extends 'base.html' %}
{% load static %}

{% block title %}Reset Password - Employee Task Management{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-key me-2"></i>Reset Password
        </h1>
        <p class="text-muted">Set a new password for user</p>
    </div>
    <div>
        <a href="{% url 'users:user_detail' target_user.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to User
        </a>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-user-edit me-2"></i>Reset Password for {{ target_user.get_full_name|default:target_user.username }}
                </h5>
            </div>
            <div class="card-body">
                <!-- User Info -->
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle fa-2x me-3"></i>
                        <div>
                            <strong>User:</strong> {{ target_user.get_full_name|default:target_user.username }}<br>
                            <strong>Username:</strong> @{{ target_user.username }}<br>
                            <strong>Email:</strong> {{ target_user.email }}
                        </div>
                    </div>
                </div>

                <form method="post" id="resetPasswordForm">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="new_password" class="form-label">New Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="new_password" name="new_password" 
                                   required minlength="8" placeholder="Enter new password">
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Password must be at least 8 characters long
                        </div>
                        <div class="password-strength mt-2" id="passwordStrength">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted" id="strengthText">Password strength</small>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirm_password" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                   required minlength="8" placeholder="Confirm new password">
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">
                            Re-enter the password to confirm
                        </div>
                        <div class="mt-2" id="passwordMatch">
                            <small class="text-muted">Passwords will be checked for match</small>
                        </div>
                    </div>
                    
                    <!-- Password Requirements -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>Password Requirements
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0" id="passwordRequirements">
                                <li class="mb-2">
                                    <i class="fas fa-circle text-muted me-2"></i>
                                    <span>At least 8 characters long</span>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-circle text-muted me-2"></i>
                                    <span>Contains uppercase letter</span>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-circle text-muted me-2"></i>
                                    <span>Contains lowercase letter</span>
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-circle text-muted me-2"></i>
                                    <span>Contains number</span>
                                </li>
                                <li>
                                    <i class="fas fa-circle text-muted me-2"></i>
                                    <span>Contains special character</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'users:user_detail' target_user.pk %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-warning" id="submitBtn">
                            <i class="fas fa-key me-2"></i>Reset Password
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Security Notice -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>Security Notice
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-0">
                    <ul class="mb-0">
                        <li>This action will immediately change the user's password</li>
                        <li>The user will need to use the new password on their next login</li>
                        <li>Consider notifying the user about this password change</li>
                        <li>This action is logged for security purposes</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for password validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('resetPasswordForm');
    const newPassword = document.getElementById('new_password');
    const confirmPassword = document.getElementById('confirm_password');
    const togglePassword = document.getElementById('togglePassword');
    const toggleConfirmPassword = document.getElementById('toggleConfirmPassword');
    const passwordMatch = document.getElementById('passwordMatch');
    const passwordStrength = document.getElementById('passwordStrength');
    const strengthText = document.getElementById('strengthText');
    const progressBar = passwordStrength.querySelector('.progress-bar');
    const requirements = document.getElementById('passwordRequirements');
    const submitBtn = document.getElementById('submitBtn');
    
    // Toggle password visibility
    togglePassword.addEventListener('click', function() {
        const type = newPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        newPassword.setAttribute('type', type);
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
    });
    
    toggleConfirmPassword.addEventListener('click', function() {
        const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPassword.setAttribute('type', type);
        this.querySelector('i').classList.toggle('fa-eye');
        this.querySelector('i').classList.toggle('fa-eye-slash');
    });
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = [
            password.length >= 8,
            /[A-Z]/.test(password),
            /[a-z]/.test(password),
            /[0-9]/.test(password),
            /[^A-Za-z0-9]/.test(password)
        ];
        
        strength = requirements.filter(Boolean).length;
        
        return {
            score: strength,
            requirements: requirements
        };
    }
    
    // Update password strength display
    function updatePasswordStrength() {
        const password = newPassword.value;
        const result = checkPasswordStrength(password);
        
        // Update progress bar
        const percentage = (result.score / 5) * 100;
        progressBar.style.width = percentage + '%';
        
        // Update progress bar color
        if (percentage < 40) {
            progressBar.className = 'progress-bar bg-danger';
            strengthText.textContent = 'Weak';
        } else if (percentage < 80) {
            progressBar.className = 'progress-bar bg-warning';
            strengthText.textContent = 'Medium';
        } else {
            progressBar.className = 'progress-bar bg-success';
            strengthText.textContent = 'Strong';
        }
        
        // Update requirements list
        const requirementItems = requirements.querySelectorAll('li');
        result.requirements.forEach((met, index) => {
            const icon = requirementItems[index].querySelector('i');
            if (met) {
                icon.className = 'fas fa-check text-success me-2';
            } else {
                icon.className = 'fas fa-circle text-muted me-2';
            }
        });
    }
    
    // Check password match
    function checkPasswordMatch() {
        const match = newPassword.value === confirmPassword.value;
        
        if (newPassword.value && confirmPassword.value) {
            if (match) {
                passwordMatch.innerHTML = '<small class="text-success"><i class="fas fa-check me-1"></i>Passwords match</small>';
                confirmPassword.classList.remove('is-invalid');
                confirmPassword.classList.add('is-valid');
            } else {
                passwordMatch.innerHTML = '<small class="text-danger"><i class="fas fa-times me-1"></i>Passwords do not match</small>';
                confirmPassword.classList.remove('is-valid');
                confirmPassword.classList.add('is-invalid');
            }
        } else {
            passwordMatch.innerHTML = '<small class="text-muted">Passwords will be checked for match</small>';
            confirmPassword.classList.remove('is-valid', 'is-invalid');
        }
        
        return match;
    }
    
    // Event listeners
    newPassword.addEventListener('input', updatePasswordStrength);
    newPassword.addEventListener('input', checkPasswordMatch);
    confirmPassword.addEventListener('input', checkPasswordMatch);
    
    // Form validation
    form.addEventListener('submit', function(e) {
        const password = newPassword.value;
        const confirm = confirmPassword.value;
        const strength = checkPasswordStrength(password);
        
        let isValid = true;
        
        // Check password length
        if (password.length < 8) {
            newPassword.classList.add('is-invalid');
            isValid = false;
        } else {
            newPassword.classList.remove('is-invalid');
        }
        
        // Check password match
        if (password !== confirm) {
            confirmPassword.classList.add('is-invalid');
            isValid = false;
        } else {
            confirmPassword.classList.remove('is-invalid');
        }
        
        if (!isValid) {
            e.preventDefault();
            showAlert('Please fix the errors in the form.', 'danger');
        } else {
            // Show confirmation dialog
            if (!confirm('Are you sure you want to reset the password for this user? This action cannot be undone.')) {
                e.preventDefault();
            } else {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resetting...';
            }
        }
    });
    
    // Show alert function
    function showAlert(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        const container = document.querySelector('.card-body');
        container.insertBefore(alertDiv, container.firstChild);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %} 