{% extends 'base.html' %}
{% load static %}

{% block title %}Create New Task{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="fas fa-plus me-2"></i>Create New Task
        </h1>
        <p class="text-muted">Create and assign a new task to team members</p>
    </div>
    <div>
        <a href="{% url 'tasks:task_list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Tasks
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>Task Details
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">Task Title *</label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       placeholder="Enter task title">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priority" class="form-label">Priority *</label>
                                <select class="form-select" id="priority" name="priority" required>
                                    <option value="">Select Priority</option>
                                    {% for value, label in priority_choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Description *</label>
                        <textarea class="form-control" id="description" name="description" rows="4" required
                                  placeholder="Describe the task in detail..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="project" class="form-label">Project *</label>
                                <select class="form-select" id="project" name="project" required>
                                    <option value="">Select Project</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}">{{ project.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="assigned_to" class="form-label">Assign To *</label>
                                <select class="form-select" id="assigned_to" name="assigned_to" required>
                                    <option value="">Select User</option>
                                    {% for user in users %}
                                    <option value="{{ user.id }}">{{ user.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deadline" class="form-label">Deadline *</label>
                                <input type="datetime-local" class="form-control" id="deadline" name="deadline" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="estimated_hours" class="form-label">Estimated Hours</label>
                                <input type="number" class="form-control" id="estimated_hours" name="estimated_hours" 
                                       step="0.5" min="0" placeholder="e.g., 8.5">
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Task
                        </button>
                        <a href="{% url 'tasks:task_list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <!-- Quick Tips -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>Quick Tips
                </h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Use clear, descriptive titles
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Set realistic deadlines
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Choose appropriate priority levels
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        Provide detailed descriptions
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success me-2"></i>
                        Estimate time accurately
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Project Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-project-diagram me-2"></i>Project Overview
                </h5>
            </div>
            <div class="card-body">
                {% if projects %}
                <div class="project-list">
                    {% for project in projects %}
                    <div class="project-item mb-3 p-3 border rounded">
                        <h6 class="mb-1">{{ project.name }}</h6>
                        <small class="text-muted">{{ project.description|truncatewords:10 }}</small>
                        <div class="mt-2">
                            <span class="badge bg-primary">{{ project.task_count }} tasks</span>
                            <span class="badge bg-success">{{ project.completed_tasks }} completed</span>
                        </div>
                        <div class="progress mt-2" style="height: 4px;">
                            <div class="progress-bar bg-success" style="width: {{ project.progress_percentage }}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No projects available</p>
                <a href="{% url 'tasks:create_project' %}" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-plus me-2"></i>Create Project
                </a>
                {% endif %}
            </div>
        </div>
        
        <!-- Team Members -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2"></i>Team Members
                </h5>
            </div>
            <div class="card-body">
                {% if users %}
                <div class="team-list">
                    {% for user in users %}
                    <div class="team-member d-flex align-items-center mb-2">
                        <div class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2">
                            {{ user.first_name|first }}{{ user.last_name|first }}
                        </div>
                        <div class="flex-grow-1">
                            <strong>{{ user.get_full_name }}</strong>
                            <br>
                            <small class="text-muted">{{ user.userprofile.role|title }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted">No team members available</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Auto-select current date and time for deadline
document.addEventListener('DOMContentLoaded', function() {
    const now = new Date();
    const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
    document.getElementById('deadline').value = localDateTime;
    
    // Auto-focus on title field
    document.getElementById('title').focus();
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const title = document.getElementById('title').value.trim();
    const description = document.getElementById('description').value.trim();
    const project = document.getElementById('project').value;
    const assignedTo = document.getElementById('assigned_to').value;
    const deadline = document.getElementById('deadline').value;
    
    if (!title || !description || !project || !assignedTo || !deadline) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
    
    // Check if deadline is in the future
    const deadlineDate = new Date(deadline);
    const now = new Date();
    if (deadlineDate <= now) {
        e.preventDefault();
        alert('Deadline must be in the future.');
        return false;
    }
});
</script>

<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 12px;
}

.project-item {
    transition: background-color 0.2s;
}

.project-item:hover {
    background-color: #f8f9fa;
}

.team-member {
    transition: background-color 0.2s;
    padding: 8px;
    border-radius: 4px;
}

.team-member:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %} 